{% comment %}
  Header Section - Secure Implementation

  Security Features:
  - Proper Liquid escaping for all user data
  - CSRF protection for forms
  - Input validation and sanitization
  - XSS prevention measures
{% endcomment %}

<header class="header" data-section-id="{{ section.id }}" data-section-type="header">
  <div class="container">
    <nav class="nav" role="navigation" aria-label="{{ 'layout.header.menu' | t | escape }}">

      <!-- Logo -->
      <a href="{{ routes.root_url }}" class="nav__logo" aria-label="{{ 'layout.header.logo_alt' | t | escape }}">
          {% if section.settings.logo %}
            <img
              src="{{ section.settings.logo | img_url: '200x' }}"
              alt="{{ shop.name | escape }}"
              width="auto"
              height="40"
              loading="eager"
              decoding="async"
            >
          {% else %}
            <img
              src="{{ 'midnight-magnolia-logo.jpg' | asset_url }}"
              alt="{{ shop.name | escape }}"
              width="auto"
              height="40"
              loading="eager"
              decoding="async"
            >
          {% endif %}
      </a>

      <!-- Main Navigation -->
      {% if linklists[section.settings.main_menu_linklist].links.size > 0 %}
        <ul class="nav__menu list-unstyled" role="menubar">
          {% for link in linklists[section.settings.main_menu_linklist].links %}
            <li class="nav__item" role="none">
              {% if link.links != blank %}
                <!-- Dropdown Menu -->
                <div class="nav__item--dropdown" role="menuitem" aria-haspopup="true" aria-expanded="false">
                  <a href="{{ link.url | escape }}" class="nav__link" aria-expanded="false">
                    {{ link.title | escape }}
                    <span class="nav__dropdown-icon" aria-hidden="true">â–¼</span>
                  </a>
                  <ul class="nav__dropdown" role="menu" aria-label="{{ link.title | escape }} submenu">
                    {% for childlink in link.links %}
                      <li class="nav__dropdown-item" role="none">
                        <a href="{{ childlink.url | escape }}" class="nav__dropdown-link" role="menuitem">
                          {{ childlink.title | escape }}
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% else %}
                <!-- Regular Link -->
                <a href="{{ link.url | escape }}" class="nav__link" role="menuitem">
                  {{ link.title | escape }}
                </a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% endif %}

      <!-- Header Actions -->
      <div class="nav__actions">

        <!-- Search -->
        {% if section.settings.enable_search %}
          <div class="nav__search">
            <button type="button" class="nav__search-toggle" aria-label="{{ 'layout.header.search' | t | escape }}">
              <svg aria-hidden="true" focusable="false" width="20" height="20" viewBox="0 0 20 20">
                <path fill="currentColor" d="M7.5 1C3.91 1 1 3.91 1 7.5S3.91 14 7.5 14 14 11.09 14 7.5 11.09 1 7.5 1zM7.5 12C5.01 12 3 9.99 3 7.5S5.01 3 7.5 3 12 5.01 12 7.5 9.99 12 7.5 12z"/>
                <path fill="currentColor" d="m13 13-6.44-6.44.88-.88L14 12.24z"/>
              </svg>
            </button>
            <div class="nav__search-form" hidden>
              <form action="{{ routes.search_url }}" method="get" class="search-form" role="search">
                <label for="search-input" class="visually-hidden">{{ 'search.general.placeholder' | t | escape }}</label>
                <input
                  type="search"
                  id="search-input"
                  name="q"
                  value="{{ search.terms | escape }}"
                  placeholder="{{ 'search.general.placeholder' | t | escape }}"
                  aria-label="{{ 'search.general.placeholder' | t | escape }}"
                  autocomplete="off"
                  maxlength="100"
                  class="form-input"
                >
                <button type="submit" class="btn btn--ghost" aria-label="{{ 'search.general.submit' | t | escape }}">
                  {{ 'search.general.submit' | t | escape }}
                </button>
              </form>
            </div>
          </div>
        {% endif %}

        <!-- Account -->
        <a href="{{ routes.account_url }}" class="nav__account" aria-label="{{ 'layout.header.account' | t | escape }}">
          <svg aria-hidden="true" focusable="false" width="20" height="20" viewBox="0 0 20 20">
            <circle cx="10" cy="6" r="4" fill="none" stroke="currentColor" stroke-width="2"/>
            <path d="M10 14c-5.52 0-10 2.24-10 5v1h20v-1c0-2.76-4.48-5-10-5z" fill="none" stroke="currentColor" stroke-width="2"/>
          </svg>
        </a>

        <!-- Cart -->
        <a href="{{ routes.cart_url }}" class="nav__cart" aria-label="{{ 'layout.header.cart' | t | escape }} ({{ cart.item_count }})">
          <svg aria-hidden="true" focusable="false" width="20" height="20" viewBox="0 0 20 20">
            <path fill="currentColor" d="M3 3h2l.4 2h11.2c.2 0 .4.2.4.4 0 .1 0 .2-.1.3l-2.5 4.6c-.1.2-.3.3-.5.3H7.7l.3 1.5h8.5c.3 0 .5.2.5.5s-.2.5-.5.5H7.5c-.2 0-.4-.1-.5-.3L4.5 4H3c-.3 0-.5-.2-.5-.5S2.7 3 3 3zm5 14c.8 0 1.5.7 1.5 1.5S8.8 20 8 20s-1.5-.7-1.5-1.5S7.2 17 8 17zm8 0c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5z"/>
          </svg>
          {% if cart.item_count > 0 %}
            <span class="cart-count" aria-label="{{ cart.item_count }} {{ 'layout.header.cart' | t | escape }}">
              {{ cart.item_count }}
            </span>
          {% endif %}
        </a>

      </div>
    </nav>
  </div>
</header>

<style>
  /* Header-specific secure styles */
  .nav__dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background: rgba(26, 26, 46, 0.98);
    border: 1px solid rgba(247, 243, 233, 0.1);
    border-radius: var(--radius-sm);
    min-width: 200px;
    z-index: var(--z-dropdown);
    box-shadow: var(--shadow-mystical);
  }

  .nav__item--dropdown:hover .nav__dropdown,
  .nav__item--dropdown:focus-within .nav__dropdown {
    display: block;
  }

  .nav__search-form[hidden] {
    display: none;
  }

  .cart-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--color-golden-yellow);
    color: var(--color-midnight-navy);
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
  }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .nav__menu {
      display: none;
    }
  }
</style>

<script>
  // Secure header functionality
  document.addEventListener('DOMContentLoaded', function() {
    const header = document.querySelector('[data-section-type="header"]');
    if (!header) return;

    // Search toggle functionality
    const searchToggle = header.querySelector('.nav__search-toggle');
    const searchForm = header.querySelector('.nav__search-form');

    if (searchToggle && searchForm) {
      searchToggle.addEventListener('click', function(e) {
        e.preventDefault();
        const isHidden = searchForm.hasAttribute('hidden');

        if (isHidden) {
          searchForm.removeAttribute('hidden');
          searchForm.querySelector('input').focus();
          this.setAttribute('aria-expanded', 'true');
        } else {
          searchForm.setAttribute('hidden', '');
          this.setAttribute('aria-expanded', 'false');
        }
      });

      // Close search when clicking outside
      document.addEventListener('click', function(e) {
        if (!header.contains(e.target)) {
          searchForm.setAttribute('hidden', '');
          searchToggle.setAttribute('aria-expanded', 'false');
        }
      });
    }

    // Dropdown accessibility
    const dropdowns = header.querySelectorAll('.nav__item--dropdown');
    dropdowns.forEach(dropdown => {
      const link = dropdown.querySelector('.nav__link');
      const menu = dropdown.querySelector('.nav__dropdown');

      if (link && menu) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const isExpanded = this.getAttribute('aria-expanded') === 'true';
          this.setAttribute('aria-expanded', !isExpanded);
        });

        // Keyboard navigation
        link.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const isExpanded = this.getAttribute('aria-expanded') === 'true';
            this.setAttribute('aria-expanded', !isExpanded);
          }
        });
      }
    });
  });
</script>

{% schema %}
{
  "name": "Header",
  "settings": [
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo Image"
    },
    {
      "type": "link_list",
      "id": "main_menu_linklist",
      "label": "Main Menu",
      "default": "main-menu"
    },
    {
      "type": "checkbox",
      "id": "enable_search",
      "label": "Enable Search",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_cart_drawer",
      "label": "Enable Cart Drawer",
      "default": false
    }
  ]
}
{% endschema %}
