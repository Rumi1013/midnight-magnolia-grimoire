{% comment %}
  Home Carousel — Midnight Magnolia
  - Sets sanctuary mood with soft, certain slides
  - Accessible controls, reduced-motion aware, minimal JS
{% endcomment %}

<section class="home-carousel" data-section-id="{{ section.id }}" aria-label="Homepage carousel">
  <div class="home-carousel__viewport" role="region" aria-roledescription="carousel" aria-label="Featured" tabindex="0"
       data-autoplay="{{ section.settings.autoplay }}"
       data-interval="{{ section.settings.interval | times: 1000 }}">

    <div class="home-carousel__track" aria-live="polite">
      {% if section.blocks.size > 0 %}
        {% for block in section.blocks %}
          {% assign align = block.settings.alignment | default: 'center' %}
          <article class="home-carousel__slide is-{{ section.settings.height }} align-{{ align }}" {{ block.shopify_attributes }}>
            {% if block.settings.image %}
              <picture>
                {% if block.settings.image_mobile %}
                  <source media="(max-width: 640px)" srcset="{{ block.settings.image_mobile | img_url: '900x' }}">
                {% endif %}
                <img class="home-carousel__image" src="{{ block.settings.image | img_url: '1800x' }}" alt="{{ block.settings.alt | default: block.settings.heading | escape }}" loading="eager" decoding="async">
              </picture>
            {% endif %}

            <div class="home-carousel__overlay" style="--overlay: {{ block.settings.overlay | default: 40 }}%"></div>

            <div class="home-carousel__content">
              {% if block.settings.kicker != blank %}
                <p class="home-carousel__kicker">{{ block.settings.kicker | escape }}</p>
              {% endif %}
              {% if block.settings.heading != blank %}
                <h2 class="home-carousel__heading">{{ block.settings.heading | escape }}</h2>
              {% endif %}
              {% if block.settings.subtext != blank %}
                <div class="home-carousel__subtext user-content">{{ block.settings.subtext }}</div>
              {% endif %}
              {% if block.settings.cta_label != blank and block.settings.cta_url != blank %}
                <div class="home-carousel__actions">
                  <a class="btn btn--primary" href="{{ block.settings.cta_url }}">{{ block.settings.cta_label | escape }}</a>
                  {% if block.settings.cta_secondary_label != blank and block.settings.cta_secondary_url != blank %}
                    <a class="btn btn--ghost" href="{{ block.settings.cta_secondary_url }}">{{ block.settings.cta_secondary_label | escape }}</a>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      {% else %}
        <article class="home-carousel__slide is-medium align-center">
          <div class="home-carousel__fallback">
            <h2 class="home-carousel__heading">Welcome to your digital sanctuary</h2>
            <p class="home-carousel__subtext">Southern Gothic grace, ancestral wisdom, and soft certainty.</p>
          </div>
        </article>
      {% endif %}
    </div>

    {% if section.settings.show_arrows %}
      <button class="home-carousel__nav prev" aria-label="Previous slide">‹</button>
      <button class="home-carousel__nav next" aria-label="Next slide">›</button>
    {% endif %}

    {% if section.settings.show_pagination and section.blocks.size > 1 %}
      <div class="home-carousel__dots" role="tablist" aria-label="Carousel Pagination">
        {% for block in section.blocks %}
          <button class="home-carousel__dot" role="tab" aria-selected="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="slide-{{ forloop.index }}" data-index="{{ forloop.index0 }}">
            <span class="visually-hidden">Slide {{ forloop.index }}</span>
          </button>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</section>

<style>
  .home-carousel { position: relative; isolation: isolate; }
  .home-carousel__viewport { position: relative; }
  .home-carousel__track {
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: 100%;
    scroll-snap-type: x mandatory;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
  }
  .home-carousel__slide {
    position: relative;
    height: 70vh;
    min-height: 420px;
    max-height: 880px;
    scroll-snap-align: start;
    display: grid;
    place-items: center;
    background: #0f1225;
    color: var(--color-warm-cream);
  }
  .home-carousel__slide.is-small { height: 50vh; }
  .home-carousel__slide.is-medium { height: 70vh; }
  .home-carousel__slide.is-large { height: 85vh; }

  .home-carousel__image { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; object-position: center; z-index: -2; }
  .home-carousel__overlay { position: absolute; inset: 0; background: linear-gradient(180deg, rgba(15,18,37,0.5), rgba(15,18,37,0.6)); z-index: -1; }
  .home-carousel__overlay { background: linear-gradient(180deg, rgba(15,18,37, calc(var(--overlay,40)/100)), rgba(15,18,37, calc(var(--overlay,40)/100))); }

  .home-carousel__content { text-align: center; padding-inline: var(--container-padding); max-width: 900px; }
  .home-carousel__kicker { font-family: var(--font-ui-family); letter-spacing: .08em; text-transform: uppercase; opacity: .9; margin-bottom: .5rem; }
  .home-carousel__heading { font-family: var(--font-heading-family); font-size: clamp(2rem, 5vw, 4rem); margin-bottom: 1rem; }
  .home-carousel__subtext { font-size: clamp(1.05rem, 2vw, 1.25rem); margin-bottom: 1.5rem; }
  .home-carousel__actions { display: inline-flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center; }

  .home-carousel__slide.align-left  .home-carousel__content { text-align: left; }
  .home-carousel__slide.align-right .home-carousel__content { text-align: right; }

  .home-carousel__nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(15,18,37,.6); border: 1px solid rgba(247,243,233,.2); color: var(--color-warm-cream); border-radius: var(--radius-full); width: 40px; height: 40px; display: grid; place-items: center; cursor: pointer; }
  .home-carousel__nav.prev { left: 12px; }
  .home-carousel__nav.next { right: 12px; }

  .home-carousel__dots { position: absolute; bottom: 14px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; }
  .home-carousel__dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,.35); border: none; cursor: pointer; }
  .home-carousel__dot[aria-selected="true"] { background: var(--color-golden-yellow); }

  @media (prefers-reduced-motion: reduce) {
    .home-carousel__track { scroll-behavior: auto; }
  }
  {% if settings.enable_motion_toggle == false or settings.reduce_motion_default %}
    .home-carousel__track { scroll-behavior: auto !important; }
  {% endif %}
</style>

<script>
  (function(){
    const section = document.currentScript.closest('.home-carousel');
    if (!section) return;
    const viewport = section.querySelector('.home-carousel__viewport');
    const track = section.querySelector('.home-carousel__track');
    const slides = Array.from(section.querySelectorAll('.home-carousel__slide'));
    const dots = Array.from(section.querySelectorAll('.home-carousel__dot'));
    const prevBtn = section.querySelector('.home-carousel__nav.prev');
    const nextBtn = section.querySelector('.home-carousel__nav.next');

    let index = 0;
    let timer = null;
    const autoplay = viewport?.dataset.autoplay === 'true';
    const interval = parseInt(viewport?.dataset.interval || '5000', 10);

    const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches || ({{ settings.enable_motion_toggle | json }} === false) || ({{ settings.reduce_motion_default | json }} === true);

    function goTo(i){
      index = (i + slides.length) % slides.length;
      track.scrollTo({ left: index * track.clientWidth, behavior: reduceMotion ? 'auto' : 'smooth' });
      dots.forEach((d, di) => d.setAttribute('aria-selected', di === index ? 'true' : 'false'));
    }

    function next(){ goTo(index + 1); }
    function prev(){ goTo(index - 1); }

    function start(){ if (autoplay && slides.length > 1) { stop(); timer = setInterval(next, interval); } }
    function stop(){ if (timer) { clearInterval(timer); timer = null; } }

    // Resize observer to keep widths aligned
    const ro = new ResizeObserver(() => goTo(index));
    ro.observe(track);

    dots.forEach((d) => d.addEventListener('click', () => { stop(); goTo(parseInt(d.dataset.index, 10)); start(); }));
    prevBtn && prevBtn.addEventListener('click', () => { stop(); prev(); start(); });
    nextBtn && nextBtn.addEventListener('click', () => { stop(); next(); start(); });

    // Keyboard support
    viewport && viewport.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight') { e.preventDefault(); stop(); next(); start(); }
      if (e.key === 'ArrowLeft') { e.preventDefault(); stop(); prev(); start(); }
    });

    start();
  })();
</script>

{% schema %}
{
  "name": "Home carousel",
  "settings": [
    { "type": "select", "id": "height", "label": "Height", "default": "medium", "options": [
      {"value":"small","label":"Small"}, {"value":"medium","label":"Medium"}, {"value":"large","label":"Large"}
    ]},
    { "type": "checkbox", "id": "autoplay", "label": "Autoplay", "default": true },
    { "type": "range", "id": "interval", "label": "Autoplay interval (seconds)", "min": 3, "max": 10, "step": 1, "unit": "s", "default": 5 },
    { "type": "checkbox", "id": "show_arrows", "label": "Show arrows", "default": true },
    { "type": "checkbox", "id": "show_pagination", "label": "Show pagination dots", "default": true }
  ],
  "blocks": [
    { "type": "slide", "name": "Slide", "settings": [
      { "type": "text", "id": "kicker", "label": "Kicker" },
      { "type": "text", "id": "heading", "label": "Heading", "default": "Digital sanctuary" },
      { "type": "richtext", "id": "subtext", "label": "Subtext", "default": "<p>Southern Gothic grace meets ancestral wisdom.</p>" },
      { "type": "image_picker", "id": "image", "label": "Image (desktop)" },
      { "type": "image_picker", "id": "image_mobile", "label": "Image (mobile)" },
      { "type": "text", "id": "alt", "label": "Image alt text" },
      { "type": "range", "id": "overlay", "label": "Overlay strength", "min": 0, "max": 80, "step": 5, "unit": "%", "default": 40 },
      { "type": "text", "id": "cta_label", "label": "Primary button label", "default": "Enter the Garden" },
      { "type": "url", "id": "cta_url", "label": "Primary button link" },
      { "type": "text", "id": "cta_secondary_label", "label": "Secondary button label" },
      { "type": "url", "id": "cta_secondary_url", "label": "Secondary button link" },
      { "type": "select", "id": "alignment", "label": "Content alignment", "default": "center", "options": [
        {"value":"left","label":"Left"},{"value":"center","label":"Center"},{"value":"right","label":"Right"}
      ]}
    ]}
  ],
  "presets": [
    { "name": "Home carousel", "category": "Image", "blocks": [
      {"type":"slide","settings":{"kicker":"Welcome","heading":"Digital sanctuary","subtext":"<p>Southern Gothic grace meets ancestral wisdom.</p>","cta_label":"Shop now"}},
      {"type":"slide","settings":{"kicker":"New","heading":"Seasonal capsule","subtext":"<p>Quiet picks aligned with the moon.</p>","cta_label":"Explore"}}
    ]}
  ]
}
{% endschema %}
